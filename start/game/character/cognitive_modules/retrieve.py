"""
Author: Joon Sung Park (joonspk@stanford.edu)

File: retrieve.py
Description: This defines the "Retrieve" module for generative agents. 
"""
from numpy.linalg import norm
from numpy import dot
from core.global_methods import *
from game.llm import LLMProvider
from game.character.character import *

class RetrieveAction:
    def __init__(self, llm: LLMProvider):
        self._llm = llm

    def retrieve(self, persona: Character, perceived):
      """
      This function takes the events that are perceived by the persona as input
      and returns a set of related events and thoughts that the persona would 
      need to consider as context when planning. 

      INPUT: 
        perceived: a list of event <ConceptNode>s that represent any of the events
        `         that are happening around the persona. What is included in here
                  are controlled by the att_bandwidth and retention 
                  hyper-parameters.
      OUTPUT: 
        retrieved: a dictionary of dictionary. The first layer specifies an event, 
                  while the latter layer specifies the "curr_event", "events", 
                  and "thoughts" that are relevant.
      """
      # We rerieve events and thoughts separately.
      retrieved = dict()
      for event in perceived:
          retrieved[event.description] = dict()
          retrieved[event.description]["curr_event"] = event

          relevant_events = persona.associative_memory.retrieve_relevant_events(
              event.subject, event.predicate, event.object)
          retrieved[event.description]["events"] = list(relevant_events)

          relevant_thoughts = persona.associative_memory.retrieve_relevant_thoughts(
              event.subject, event.predicate, event.object)
          retrieved[event.description]["thoughts"] = list(relevant_thoughts)

      return retrieved
    
    def new_retrieve(self, persona: Character, focal_points: List[str], n_count=30):
      """
      Given the current persona and focal points (focal points are events or 
      thoughts for which we are retrieving), we retrieve a set of nodes for each
      of the focal points and return a dictionary. 

      INPUT: 
        persona: The current persona object whose memory we are retrieving. 
        focal_points: A list of focal points (string description of the events or
                      thoughts that is the focus of current retrieval).
      OUTPUT: 
        retrieved: A dictionary whose keys are a string focal point, and whose 
                  values are a list of Node object in the agent's associative 
                  memory.

      Example input:
        persona = <persona> object 
        focal_points = ["How are you?", "Jane is swimming in the pond"]
      """
      # <retrieved> is the main dictionary that we are returning
      retrieved = dict()
      for focal_pt in focal_points:
          # Getting all nodes from the agent's memory (both thoughts and events) and
          # sorting them by the datetime of creation.
          # You could also imagine getting the raw conversation, but for now.
          nodes = [[i.last_accessed, i]
                  for i in persona.associative_memory.seq_event + persona.associative_memory.seq_thought
                  if "idle" not in i.embedding_key]
          nodes = sorted(nodes, key=lambda x: x[0])
          nodes = [i for created, i in nodes]

          # Calculating the component dictionaries and normalizing them.
          recency_out = self.extract_recency(persona, nodes)
          recency_out = self.normalize_dict_floats(recency_out, 0, 1)
          importance_out = self.extract_importance(persona, nodes)
          importance_out = self.normalize_dict_floats(importance_out, 0, 1)
          relevance_out = self.extract_relevance(persona, nodes, focal_pt)
          relevance_out = self.normalize_dict_floats(relevance_out, 0, 1)

          # Computing the final scores that combines the component values.
          # Note to self: test out different weights. [1, 1, 1] tends to work
          # decently, but in the future, these weights should likely be learned,
          # perhaps through an RL-like process.
          # gw = [1, 1, 1]
          # gw = [1, 2, 1]
          gw = [0.5, 3, 2]
          master_out = dict()
          for key in recency_out.keys():
              master_out[key] = (persona.scratch_memory.recency_w*recency_out[key]*gw[0]
                                + persona.scratch_memory.relevance_w *
                                relevance_out[key]*gw[1]
                                + persona.scratch_memory.importance_w*importance_out[key]*gw[2])

          master_out = self.top_highest_x_values(master_out, len(master_out.keys()))
          # for key, val in master_out.items():
          #     print(
          #         persona.associative_memory.id_to_node[key].embedding_key, val)
          #     print(persona.scratch_memory.recency_w*recency_out[key]*1,
          #           persona.scratch_memory.relevance_w*relevance_out[key]*1,
          #           persona.scratch_memory.importance_w*importance_out[key]*1)

          # Extracting the highest x values.
          # <master_out> has the key of node.id and value of float. Once we get the
          # highest x values, we want to translate the node.id into nodes and return
          # the list of nodes.
          master_out = self.top_highest_x_values(master_out, n_count)
          master_nodes = [persona.associative_memory.id_to_node[key]
                          for key in list(master_out.keys())]

          for n in master_nodes:
              n.last_accessed = persona.scratch_memory.curr_time

          retrieved[focal_pt] = master_nodes

      return retrieved


    def cos_sim(a, b):
      """
      This function calculates the cosine similarity between two input vectors 
      'a' and 'b'. Cosine similarity is a measure of similarity between two 
      non-zero vectors of an inner product space that measures the cosine 
      of the angle between them.

      INPUT: 
        a: 1-D array object 
        b: 1-D array object 
      OUTPUT: 
        A scalar value representing the cosine similarity between the input 
        vectors 'a' and 'b'.

      Example input: 
        a = [0.3, 0.2, 0.5]
        b = [0.2, 0.2, 0.5]
      """
      return dot(a, b)/(norm(a)*norm(b))


    def normalize_dict_floats(self, d, target_min, target_max):
      """
      This function normalizes the float values of a given dictionary 'd' between 
      a target minimum and maximum value. The normalization is done by scaling the
      values to the target range while maintaining the same relative proportions 
      between the original values.

      INPUT: 
        d: Dictionary. The input dictionary whose float values need to be 
          normalized.
        target_min: Integer or float. The minimum value to which the original 
                    values should be scaled.
        target_max: Integer or float. The maximum value to which the original 
                    values should be scaled.
      OUTPUT: 
        d: A new dictionary with the same keys as the input but with the float
          values normalized between the target_min and target_max.

      Example input: 
        d = {'a':1.2,'b':3.4,'c':5.6,'d':7.8}
        target_min = -5
        target_max = 5
      """
      min_val = min(val for val in d.values())
      max_val = max(val for val in d.values())
      range_val = max_val - min_val

      if range_val == 0:
          for key, val in d.items():
              d[key] = (target_max - target_min)/2
      else:
          for key, val in d.items():
              d[key] = ((val - min_val) * (target_max - target_min)
                        / range_val + target_min)
      return d


    def top_highest_x_values(self, d, x):
      """
      This function takes a dictionary 'd' and an integer 'x' as input, and 
      returns a new dictionary containing the top 'x' key-value pairs from the 
      input dictionary 'd' with the highest values.

      INPUT: 
        d: Dictionary. The input dictionary from which the top 'x' key-value pairs 
          with the highest values are to be extracted.
        x: Integer. The number of top key-value pairs with the highest values to
          be extracted from the input dictionary.
      OUTPUT: 
        A new dictionary containing the top 'x' key-value pairs from the input 
        dictionary 'd' with the highest values.

      Example input: 
        d = {'a':1.2,'b':3.4,'c':5.6,'d':7.8}
        x = 3
      """
      top_v = dict(sorted(d.items(),
                          key=lambda item: item[1],
                          reverse=True)[:x])
      return top_v


    def extract_recency(self, persona: Character, nodes):
      """
      Gets the current Persona object and a list of nodes that are in a 
      chronological order, and outputs a dictionary that has the recency score
      calculated.

      INPUT: 
        persona: Current persona whose memory we are retrieving. 
        nodes: A list of Node object in a chronological order. 
      OUTPUT: 
        recency_out: A dictionary whose keys are the node.node_id and whose values
                    are the float that represents the recency score. 
      """
      recency_vals = [persona.scratch_memory.recency_decay ** i
                      for i in range(1, len(nodes) + 1)]

      recency_out = dict()
      for count, node in enumerate(nodes):
          recency_out[node.node_id] = recency_vals[count]
      
      return recency_out


    def extract_importance(self, persona, nodes):
      """
      Gets the current Persona object and a list of nodes that are in a 
      chronological order, and outputs a dictionary that has the importance score
      calculated.

      INPUT: 
        persona: Current persona whose memory we are retrieving. 
        nodes: A list of Node object in a chronological order. 
      OUTPUT: 
        importance_out: A dictionary whose keys are the node.node_id and whose 
                        values are the float that represents the importance score.
      """
      importance_out = dict()
      for count, node in enumerate(nodes):
          importance_out[node.node_id] = node.poignancy

      return importance_out


    def extract_relevance(self, persona, nodes, focal_pt):
        """
        Gets the current Persona object, a list of nodes that are in a 
        chronological order, and the focal_pt string and outputs a dictionary 
        that has the relevance score calculated.

        INPUT: 
          persona: Current persona whose memory we are retrieving. 
          nodes: A list of Node object in a chronological order. 
          focal_pt: A string describing the current thought of revent of focus.  
        OUTPUT: 
          relevance_out: A dictionary whose keys are the node.node_id and whose values
                      are the float that represents the relevance score. 
        """
        # focal_embedding = get_embedding(focal_pt)

        focal_embedding = [-0.022794224321842194, -0.009670860134065151, 0.008920037187635899, -0.03175276517868042, -0.027953727170825005, 0.004113484639674425, 0.008323228918015957, -0.012282698415219784, -0.005897492170333862, -0.019957780838012695, 0.010768217034637928, 0.016530945897102356, -0.0038856707978993654, 0.0018754537450149655, -0.021228404715657234, -0.002385628642514348, 0.0314190648496151, -0.012269863858819008, 0.02561783231794834, -0.04389428347349167, -0.011249514296650887, 0.013514818623661995, -0.0037220297381281853, -0.009272987954318523, 0.015914885327219963, 0.0021626276429742575, 0.011794984340667725, -0.018122434616088867, 0.013335133902728558, -0.02759435772895813, 0.016556615009903908, 0.008432322181761265, -0.010415266267955303, -0.01917487010359764, -0.018071096390485764, -0.02887781709432602, 0.01828928478062153, -0.007893269881606102, -0.0008534999215044081, -0.008137127384543419, 0.004992653615772724, 0.004556277766823769, -0.009144642390310764, -0.010120070539414883, -0.005079287104308605, 0.009895465336740017, 0.0009240901563316584, 0.0030225447844713926, -0.029699230566620827, 0.00879810843616724, 0.0500292144715786, 0.006731740199029446, -0.02075352519750595, -0.010806720703840256, 0.0002827619609888643, -0.018083930015563965, -0.018969517201185226, -0.005749894306063652, 0.002789918100461364, -0.007668664678931236, -9.375263471156359e-05, 0.006189478561282158, -0.018122434616088867, 0.00844515673816204, -0.015042133629322052, -0.0028171914163976908, 0.008766021579504013, 0.021664779633283615, 0.015927720814943314, 0.019380223006010056, 0.01601756177842617, -0.006340285297483206, 0.01229553297162056, -0.0008960145059973001, 0.011602465063333511, -0.012975765392184258, -0.023127922788262367, -0.001109389471821487, -0.012173604220151901, 0.007315713446587324, 0.025476651266217232, -0.006712488364428282, -0.003744490211829543, 0.018212277442216873, 0.006311407312750816, 0.014169381931424141, 0.007328548468649387, -0.002207548590376973, -0.020252976566553116, -0.010601367801427841, 0.005887866020202637, 0.02161344140768051, 0.0092858225107193, -0.0009537701262161136, -0.019072193652391434, 0.0034396687988191843, 0.0008021615794859827, 0.023564299568533897, 0.0003547559608705342, -0.02375681698322296, -0.008297559805214405, 0.011345773003995419, -0.028338763862848282, -0.012539389543235302, -0.017647555097937584, 0.0030048973858356476, 0.0038214977830648422, 0.005470742005854845, 0.018712826073169708, 0.008496495895087719, -0.030648989602923393, -0.004829012788832188, 0.013335133902728558, -0.03786202520132065, -0.02400067448616028, -0.006840833928436041, -0.004883559886366129, 0.0030417966190725565, 0.014169381931424141, -0.024257365614175797, 0.010594950057566166, 0.017519209533929825, 0.001447099493816495, -0.009638773277401924, 0.01990644261240959, -0.011628134176135063, 0.01130726933479309, -0.014066705480217934, -0.02319209650158882, 0.021343914791941643, 0.020342817530035973, 0.0004167229344602674, 0.007161698769778013, -0.0036706915125250816, 0.0047552138566970825, 0.021831629797816277, -0.016133073717355728, 0.020984547212719917, 0.0034845899790525436, -0.02818474918603897, 0.015080638229846954, 0.012455965392291546, -0.021805960685014725, -0.012494469061493874, -0.004809760954231024, 0.010845224373042583, 0.009163893759250641, -0.007431224919855595, -0.00039205647772178054, 0.01903369091451168, 0.020394155755639076, -0.017519209533929825, -0.0002819598012138158, -0.012706239707767963, 0.01660795323550701, 0.01642826944589615, -0.0103639280423522, 0.013463480398058891, -0.0038952967151999474, -0.023204930126667023, 0.01166022103279829, -0.02101021632552147, 0.009048382751643658, 0.021420922130346298, -0.0033113230019807816, 0.022691546007990837, -0.0001425842201570049, 0.0003467343340162188, -0.013412141241133213, 0.004604407586157322, 0.0005534914671443403, 0.01742936670780182, -0.018417630344629288, 0.03342125937342644, -0.007732837460935116, -0.00403647730126977, -0.011056995019316673, -0.01828928478062153, -0.004995862487703562, -0.0042418306693434715, -0.009638773277401924, 0.015940554440021515, -0.009613104164600372, 0.014965126290917397, -0.010325424373149872, 0.023410283029079437, 0.006834416650235653, -0.024385713040828705, 0.008682597428560257, -0.015940554440021515, -0.013925525359809399, 0.024706576019525528, 0.030494974926114082, -0.0033049057237803936, -0.6854695081710815, 0.006917841732501984, -0.012109431438148022, 0.007251540664583445, 0.027106644585728645, 0.010479439049959183, 0.007219454273581505, -0.014528750441968441, -0.016081735491752625, -0.02432153932750225, -0.01759621687233448, 0.02215249463915825, -0.002781896386295557, 0.0021979226730763912, -0.0030097102280706167, -0.02928852289915085, 5.627664904750418e-06, -0.02101021632552147, -0.006061132997274399, 0.022345013916492462, -0.022768555209040642, 0.006577725056558847, -0.0011134003289043903, 0.01644110307097435, -6.306995783234015e-05, -0.015285991132259369, 0.03303622454404831, -0.004735962022095919, -0.014759773388504982, 0.023923667147755623, -0.01686464436352253, 0.010447352193295956, -0.022255171090364456, -0.03062332049012184, 0.037528328597545624, -0.01628708839416504, 0.001196022960357368, 0.049849528819322586, -0.0033947478514164686, 0.030289622023701668, -0.02546381764113903, 0.0050279488787055016, -0.006590559612959623, -0.020342817530035973, 0.003558388678357005, 0.014246390201151371, -0.006333868019282818, 0.009869796223938465, -0.012115848250687122, 0.008817359805107117, 0.008265472948551178, -0.012314784340560436, -0.0036931519862264395, 0.020843366160988808, -0.0006236806511878967, 0.013245292007923126, 0.0036193530540913343, 0.0035615975502878428, 0.013784344308078289, 0.006337076425552368, -0.007065439131110907, -0.001453516772016883, -0.021523600444197655, 0.008278307504951954, -0.02030431479215622, 0.005897492170333862, -0.0271836519241333, 3.323957207612693e-05, 0.03218913823366165, -0.025245629251003265, 0.001240141806192696, 0.006157392170280218, -0.034525033086538315, 0.0027241406496614218, 0.011685890145599842, 0.032548509538173676, -0.0026744066271930933, -0.0009216836770065129, 0.0009353203931823373, -0.0040172250010073185, 0.013219622895121574, -0.0017134171212092042, 0.00036017055390402675, 0.004020433872938156, 0.01917487010359764, -0.01859731413424015, -0.03591116890311241, 0.004495313391089439, 0.0013636746443808079, -0.007405555807054043, 0.017365194857120514, 0.03413999825716019, -0.006924259010702372, 0.0008976188255473971, -0.005557375494390726, 0.0013877395540475845, -0.03488440439105034, -0.003837540978565812, 0.01352765318006277, -0.02887781709432602, 0.008631258271634579, -0.006725322920829058, 0.0054001519456505775, -0.0004877142491750419, 0.018815502524375916, -0.004809760954231024, -0.013501984067261219, 0.03331858292222023, 0.019341720268130302, -0.03018694557249546, -0.007405555807054043, 0.007302878890186548, -0.008149961940944195, -0.00951684545725584, -0.011602465063333511, -0.02346162125468254, 0.004845055751502514, -0.0012746347347274423, -0.0157223679125309, -0.02401350997388363, 0.008117875084280968, 0.010209912434220314, -0.00611568009480834, 0.006693236064165831, 0.0009096512221731246, -0.006526386830955744, -0.006616228725761175, -0.007495397701859474, 0.00011561153951333836, -0.0037669509183615446, 0.006827999372035265, 0.01250730361789465, 0.019816599786281586, -0.009786371141672134, 0.03419133648276329, 0.012526554986834526, 0.005072869826108217, -0.0005169931682758033, 0.018212277442216873, -0.00010072141594719142, -0.020098960027098656, -0.0035744321066886187, -0.021266907453536987, 0.013540487736463547, -0.004585155751556158, -0.03822139650583267, -0.0040621464140713215, -0.010396013967692852, -0.02015029825270176, -0.02157493866980076, -0.02744034305214882, -0.020265810191631317, -0.01443890854716301, 0.02303807996213436, 0.028775140643119812, -0.007732837460935116, 0.0019476483575999737, -0.011647386476397514, -0.02618255466222763, -0.02172895334661007, 0.003914548549801111, 0.005807649809867144, -0.0053071011789143085, -0.0010355906561017036, 0.020920373499393463, -0.01828928478062153, 0.007007683627307415, 0.00014699611347168684, -0.00865692738443613, -0.014246390201151371, 0.01407954003661871, -0.009003461338579655, 0.010460186749696732, -0.0003308916639070958, 0.021125728264451027, 0.013476314954459667, 0.02244769036769867, 0.01927754655480385, -0.0034492947161197662, -0.002961580641567707, 0.023281937465071678, -0.002955163363367319, -0.025245629251003265, -0.0014174195239320397, 0.028415771201252937, 0.01329663023352623, 0.01859731413424015, 0.006654732394963503, -0.008092205971479416, 0.009330743923783302, -0.008791690692305565, 0.0015634129522368312, -0.00010107235721079633, -0.0039690956473350525, 0.017390863969922066, 0.007418390363454819, -0.014644261449575424, 0.006391623523086309, 0.02057383954524994, 0.015106307342648506, 0.02643924579024315, -0.004530608654022217, 0.0012369331670925021, 0.01230194978415966, -0.007046187296509743, -0.018199441954493523, 0.01271907426416874, -0.029262853786349297, 0.032522838562726974, 0.020766358822584152, 0.015966223552823067, -0.058115001767873764, 0.009754285216331482, -0.02931419387459755, 0.018122434616088867, 0.030674658715724945, 0.0015072616515681148, 0.015953389927744865, -0.008509330451488495, 0.013925525359809399, 1.2408437441990827e-06, 0.006872920319437981, 0.013097694143652916, -0.01359182596206665, -0.0044760615564882755, -0.009895465336740017, -0.0027578314766287804, 0.0011711559491232038, 0.009118973277509212, -0.009933969005942345, -0.016915982589125633, -0.006263277493417263, -0.010806720703840256, 0.014900953508913517, 0.011615299619734287, -0.015452840365469456, 0.006170226726680994, -0.009972472675144672, 0.014156547375023365, 0.004328463692218065, 0.012828168459236622, 0.004267499782145023, 0.025053109973669052, 0.0103703448548913, 0.03773368149995804, -0.024218862876296043, 0.028672464191913605, 0.01431056298315525, 0.00443114060908556, 0.008887950330972672, -0.0029407243710011244, -0.017698893323540688, -0.017634719610214233, -0.0021048719063401222, 0.013283795677125454, -0.0543159656226635, -0.011198176071047783, 0.01352765318006277, 0.0008695431752130389, 0.021112892776727676, -0.005509245675057173, -0.009452671743929386, 0.004033268429338932, 0.009773536585271358, 0.0076879165135324, -0.02032998390495777, 0.003853584174066782, -0.023525794968008995, -0.010010976344347, -0.021703284233808517, -0.023410283029079437, -0.015760870650410652, 0.015773706138134003, -0.009869796223938465, -0.007938191294670105, -0.006503926124423742, -0.0053135184571146965, 0.018841171637177467, 0.0003292873443569988, -0.008156378753483295, -0.008887950330972672, -0.0314447358250618, 0.043971288949251175, 0.0021882967557758093, -0.013681667856872082, -0.014195051044225693, -0.028133410960435867, 0.009029130451381207, -0.01558118686079979, 0.02047116309404373, 0.029108839109539986, 0.015671027824282646, -0.009478340856730938, 0.011134002357721329, -0.019393058493733406, -0.010492273606359959, 0.02047116309404373, -0.002122519537806511, 0.016068900004029274, -0.004902811720967293, 0.0020743899513036013, 0.017069999128580093, 0.0023487291764467955, -0.00843873992562294, 0.0027064932510256767, 0.003051422769203782, 0.009741450659930706, -0.013784344308078289, 0.013283795677125454, -0.00043396942783147097, 0.010883728042244911, -0.0007034956943243742, -0.0286211259663105, 0.02604137361049652, 0.010511524975299835, -0.008855863474309444, -0.009747867472469807, -0.010562864132225513, -0.006603394169360399, 0.018712826073169708, -0.0019701088313013315, -0.02175462245941162, -0.022422021254897118, -0.004553069360554218, 0.10046913474798203, 0.020971711724996567, -0.016646457836031914, 0.019200539216399193, -0.00201984285376966, -0.0016989782452583313, -0.01265490148216486, 0.007213036995381117, 0.018661487847566605, -0.006141349207609892, -0.0038760448805987835, 0.008085789158940315, 0.014220720157027245, 0.006982014514505863, 0.007225871551781893, -0.001093346276320517, 0.017557712271809578, -0.023243434727191925, 0.011968250386416912, -0.013123363256454468, -0.018212277442216873, -0.005088913254439831, 0.006157392170280218, 0.022255171090364456, 0.010376762598752975, -0.029827576130628586, 0.0042482479475438595, 0.011275183409452438, 0.01843046396970749, -0.0069370935671031475, -0.006584142334759235, 0.010832389816641808, 0.005345604848116636, 0.017840074375271797, 0.00015712340245954692, 0.008297559805214405, 0.022511862218379974, -0.029776237905025482, 0.044381994754076004, -0.0021738579962402582, 0.015850713476538658, -0.0006361141568049788, 0.0004925272078253329, -0.005281432066112757, -0.017917081713676453, -0.0010379970772191882, -0.023063749074935913, 0.04476703330874443, 0.005281432066112757, -0.011852739378809929, 0.01586354710161686, -0.009722198359668255, -0.011647386476397514, -0.005082495976239443, 0.007675081957131624, 0.014336232095956802, -0.015979059040546417, -0.009709363803267479, -0.040249258279800415, 0.03321590647101402, -0.003152495017275214, -0.021549269556999207, 0.0022588870488107204, -0.0031396604608744383, 0.008547834120690823, -0.03560313954949379, -0.031701426953077316, 0.008028033189475536, -0.023808155208826065, -0.01830211840569973, 0.008612006902694702, -0.02590019255876541, -0.03544912487268448, 0.0034910072572529316, 0.02258886955678463, 0.015414336696267128, 0.018225111067295074, 0.0005141855799593031, 0.00850291270762682, 0.023795321583747864, 0.0035391368437558413, -0.021369583904743195, 0.010768217034637928, -0.015902051702141762, 0.007437642198055983, -0.03018694557249546, 0.019624080508947372, 0.002489909529685974, -0.0242958702147007, 0.019778095185756683, -0.0051274169236421585, -0.009683694690465927, 0.02618255466222763, -0.019059360027313232, 0.0007628556923009455, 0.0076365782879292965, 0.013668833300471306, -0.006795912981033325, 0.0029246811755001545, 0.01672346517443657, -0.0010781051823869348, -0.06360820680856705, -0.022909734398126602, -0.004235413391143084, -0.023204930126667023, 0.006975597236305475, 0.005836527794599533, 0.015067803673446178, -0.02928852289915085, 0.015119141899049282, 0.004832221195101738, -0.019803764298558235, 0.018379125744104385, 0.0110890818759799, 0.006340285297483206, 0.03729730471968651, 0.005329561419785023, 0.02045832946896553, 0.0015561934560537338, 0.01187199167907238, 0.002302203793078661, -0.026105547323822975, 0.016235750168561935, 0.03308756276965141, 0.0032006248366087675, 0.015799375250935555, 0.0025171830784529448, -0.02604137361049652, 0.010248416103422642, 0.003555180039256811, 0.023512959480285645, 0.01431056298315525, -0.01300143450498581, -0.01229553297162056, -0.01114683784544468, -0.03408866003155708, -0.0171341709792614, 0.016761967912316322, -0.009741450659930706, -0.00822696927934885, -0.01015857420861721, 0.022190997377038002, 0.007488980423659086, -0.02189580351114273, 0.006442961748689413, -0.02258886955678463, 0.014888118952512741, -0.003548762761056423, -0.028338763862848282, 0.010325424373149872, -0.014785442501306534, 0.028672464191913605, -0.019264712929725647, -0.014400404877960682, -0.0038824621587991714, 0.01787857711315155, -0.0096451910212636, -0.0150164645165205, 0.027132313698530197, 0.03249717131257057, 0.031958118081092834, 0.005570210050791502, 0.022653043270111084, -0.01531166024506092, -0.008008780889213085, 0.011750062927603722, -0.004588364157825708, -0.0022364265751093626, -0.0068857548758387566, 0.039684537798166275, 0.013501984067261219, 0.014297728426754475, 0.004312420729547739, 0.0012377352686598897, 0.0009385290322825313, -0.0018818710232153535, -0.012411043979227543, -0.011185341514647007, 0.007521066814661026, 0.009638773277401924, -0.002501139882951975, -0.003651439445093274, -0.009824874810874462, -0.009317909367382526, 0.010652706027030945, -0.007585240062326193, 0.013270961120724678, -0.021639110520482063, 0.025425313040614128, -0.0020631595980376005, 0.023115087300539017, -0.029262853786349297, 0.014823946170508862, 0.004752005450427532, -0.009568183682858944, -0.007957442663609982, 0.00635953713208437, 0.0009008274646475911, -0.0003162522043567151, 0.00047848938265815377, -0.006738157477229834, -0.001008317107334733, -0.004530608654022217, -0.0037862027529627085, 0.0019829433877021074, 0.04107067361474037, 0.010954318568110466, 0.0056472173891961575, 0.013694502413272858, -0.026285231113433838, -0.013964029029011726, -0.012430296279489994, -0.011442032642662525, -0.044407665729522705, -0.00671890564262867, 0.0030065015889704227, -0.007707168348133564, 0.022678712382912636, -0.013245292007923126, -0.008336063474416733, 0.0018963100155815482, 0.0033498266711831093, 0.007732837460935116, -0.0031958117615431547, 0.009677276946604252, 0.0060130031779408455, -0.011531874537467957, -0.010415266267955303, 0.04245680943131447, -0.012411043979227543, -0.010633453726768494, 0.004674997646361589, 0.004938106518238783, 0.013758675195276737, -0.0021369585301727057, 0.028698133304715157, 0.0027706660330295563, -0.0017455036286264658, -0.031393397599458694, 0.009914717637002468, 0.007983111776411533, 0.01007514912635088, -0.009844127111136913, -0.015042133629322052, -0.018776997923851013, 0.022499028593301773, -0.011082664132118225, 0.0034204169642180204, -0.005618339870125055, -0.022062651813030243, -0.008817359805107117, 0.030828673392534256, 0.024950433522462845, -0.014028201811015606, -0.005297475028783083, -0.023975005373358727, 0.006866503041237593, -0.00829114206135273, 0.01828928478062153, -0.010261250659823418, -0.017981253564357758, 0.03817005828022957, 0.011403528973460197, 0.021549269556999207, 0.00172625167760998, 0.019521404057741165, -0.008547834120690823, 0.009831292554736137, 0.006840833928436041, 0.017506374046206474, -0.022961072623729706, 0.00801519863307476, -0.00248670089058578, -0.026824282482266426, 0.007713585626333952, -0.005169129464775324, -0.015080638229846954, -0.016389764845371246, 0.013155450113117695, -0.018083930015563965, 0.01772456243634224, 0.002122519537806511, -0.017480704933404922, -0.006256860215216875, -0.0002907835878431797, -0.012173604220151901, -0.01336080301553011, -0.007014100905507803, 0.01588921621441841, 0.001202440238557756, 0.008233386091887951, -0.02302524633705616, 0.0012682174565270543, 0.013938359916210175, -0.0033402007538825274, -0.016980156302452087, -0.0016845393693074584, -0.006449379026889801, -0.023397449404001236, 0.005425821058452129, -0.020073290914297104, -0.008008780889213085, -0.014682766050100327, 0.0018449716735631227, -0.005605505313724279, -0.016261419281363487, 0.012770412489771843, -0.008772439323365688, -0.010396013967692852, -0.001913957530632615, 0.005891074892133474, -0.024809254333376884, 0.01251372043043375, -0.024770749732851982, 0.016659291461110115, -0.027799712494015694, -0.007225871551781893, -0.022717216983437538, 0.01495229173451662, 0.03675825148820877, -0.029647892341017723, -0.01486244983971119, 0.010460186749696732, -4.920759965898469e-05, -0.0008759604534134269, -0.012481634505093098, 0.009632356464862823, 0.0029182638972997665, -0.023063749074935913, 0.01066554058343172, 0.0044824788346886635, 0.026387907564640045, -0.002132145455107093, -0.015645358711481094, -0.03303622454404831, -0.007662247400730848, -0.015671027824282646, 0.029647892341017723, -0.00814354419708252, -0.012115848250687122, 0.018083930015563965, 0.021959975361824036, 0.03616786003112793, 0.014426073990762234, -0.015234652906656265, -0.023230599239468575, -0.000719538948033005, -0.007213036995381117, -0.01401536725461483, -0.020098960027098656, -0.01395119447261095, 0.008246220648288727, 0.006375580094754696, -0.021215569227933884, -0.00865692738443613, 0.010620619170367718, -0.023846659809350967, -0.007918938994407654, -0.045973483473062515, 0.0008013594197109342, -0.010935066267848015, -0.007110360078513622, 0.0036097271367907524, -0.0070782736875116825, 0.0014430886367335916, 0.027106644585728645, -0.03385763615369797, 0.002708097454160452, 0.03375495970249176, -0.008836612105369568, 0.0250274408608675, -0.013072025030851364, -0.006491091568022966, -0.005137042608112097, 0.011204592883586884, 0.009921134449541569, 0.008579920046031475, 0.025502320379018784, -0.019354553893208504, -0.02631090022623539, -0.0040685636922717094, 0.009272987954318523, 0.0047552138566970825, -0.0036803174298256636, 0.02416752465069294, -0.0092858225107193, -0.0032920711673796177, 0.007097525522112846, 0.0044760615564882755, -0.012757577933371067, 0.012539389543235302, 0.008387401700019836, 0.0023743982892483473, 0.012346871197223663, -0.013835683465003967, -0.015594021417200565, 0.0067574093118309975, -0.01758338138461113, 0.023782486096024513, -0.006189478561282158, -0.0096516078338027, 0.017827238887548447, 0.0192903820425272, 0.003651439445093274, -0.0010275689419358969, 0.021343914791941643, -0.013219622895121574, 0.015183314681053162, -0.006317824590951204, -0.011544709093868732, -0.0032984884455800056, -0.012160769663751125, 0.005621548276394606, -0.028775140643119812, 0.0026744066271930933, -0.0001946244592545554, -0.01800692267715931, -0.016094569116830826, -0.0008065734873525798, 0.002586168935522437, -0.027799712494015694, 0.00671890564262867, 0.0062857381999492645, -0.005117790773510933, -0.009998141787946224, 0.0002402473910478875, 0.011063412763178349, -0.019816599786281586, -0.005477159284055233, 0.004896394442766905, -0.023949336260557175, -0.02230650931596756, 0.005688929930329323, 0.015350163914263248, 0.02872380241751671, 0.03732297569513321, 0.22794224321842194, 0.010351093485951424, -0.015529848635196686, 0.032830867916345596, 0.006250442937016487, 0.025540824979543686, 0.029673561453819275, 0.034961409866809845, -0.0062921554781496525, 0.02117706649005413, 0.0032952798064798117, -0.02160060778260231, 0.0020471164025366306, -0.0007664653821848333, -0.0010412057163193822, -0.01889250986278057, -0.010081566870212555, -0.029519546777009964, 0.0014968335162848234, -0.03329291567206383, -0.000456028850749135, 0.0036065184976905584, 0.007565988227725029, -0.018404794856905937, 0.011390694417059422, 0.013129781000316143, 0.010652706027030945, 0.00880452524870634, 0.0023808155674487352, 0.012276280671358109, -0.0021594190038740635, 0.005595879163593054, 0.0035680148284882307, -0.0056921388022601604, -0.005252554081380367, -0.016376931220293045, -0.02273005060851574, -0.011833488009870052, 0.02143375761806965, -0.004177657421678305, 0.006519969552755356, 0.015362998470664024, -0.010113653726875782, 0.006988431792706251, 0.010652706027030945, 0.02373114787042141, -0.018083930015563965, -0.007033352740108967, 0.02962222322821617, 0.007598074618726969, -0.02643924579024315, 0.0018048635683953762, 0.0023711896501481533, 0.01875132881104946, 0.002013425575569272, -0.009343578480184078, 0.01957274228334427, -0.007970277220010757, -0.04738529026508331, 0.0096451910212636, 0.014785442501306534, 0.012500885874032974, -0.0012232963927090168, 0.018687156960368156, 0.0036097271367907524, 0.021664779633283615, -0.0056857215240597725, 0.01030617207288742, -0.003657856723293662, -0.0030081060249358416, -0.0054065692238509655, -0.008913619443774223, 0.0008607193594798446, -0.024860592558979988, -0.01272549107670784, -0.02230650931596756, 0.029083169996738434, 0.013887021690607071, 0.04620450735092163, 0.03190677985548973, -0.01551701407879591, -0.010017394088208675, 0.006815164815634489, -0.010017394088208675, -0.041686732321977615, -0.03942784667015076, -0.0056343828327953815, 0.0039017139934003353, 0.010331841185688972, -0.019855104386806488, 0.003840749617666006, -0.03229181841015816, -0.01628708839416504, -0.009003461338579655, -7.129211007850245e-05, 0.021562103182077408, 0.011993920430541039, 0.011775732040405273, -0.028287425637245178, 0.0012160770129412413, -0.010800303891301155, 0.0017069998430088162, 0.028698133304715157, -0.016915982589125633, -0.017827238887548447, 0.007251540664583445, 0.01365599874407053, 0.025425313040614128, 0.010010976344347, -0.01142919808626175, -0.013643164187669754, -0.001429451978765428, 0.002603816566988826, -0.00230701663531363, 0.0005827703862451017, -0.005701764486730099, 0.01173081062734127, -0.016954487189650536, 0.02202414907515049, -0.010967153124511242, 0.001525711384601891, -0.014965126290917397, -0.0034043737687170506, 0.001453516772016883, 0.01887967437505722, -0.016787637025117874, -0.007392721250653267, 0.009779954329133034, 0.007835513912141323, -0.02332044206559658, -0.012885923497378826, -0.017403697595000267, 0.01278966385871172, -0.005268597509711981, -0.0031236172653734684, -0.007713585626333952, 0.013707336969673634, 0.008759604766964912, -0.0020551378838717937, -0.01466993149369955, -0.005165920592844486, 0.005047200713306665, 0.0023391032591462135, 0.0074504767544567585, 0.007052604574710131, -0.013745840638875961, 0.020381322130560875, -0.007829097099602222, -0.010851642116904259, -0.0009489571675658226, -0.03406298905611038, 0.004735962022095919, 0.00958101823925972, -0.00043396942783147097, 0.033395592123270035, 0.009035548195242882, -0.0279023889452219, -0.015131976455450058, 0.0037059865426272154, 0.025373974815011024, -0.024988938122987747, 0.013245292007923126, 0.00894570630043745, 0.004674997646361589, -0.022345013916492462, -0.02175462245941162, -0.16469340026378632, 0.027260659262537956, 0.007245123386383057, -0.008990626782178879, -0.005198006983846426, 0.008560668677091599, 0.011910495348274708, -0.0250146072357893, -0.01599189266562462, 0.02016313374042511, 0.007585240062326193, -0.003731655655428767, -0.005701764486730099, -0.00023483279801439494, -0.0040108077228069305, 0.003911339677870274, -0.011352190747857094, -0.0034813813399523497, 0.028672464191913605, 0.0012834585504606366, 0.01786574348807335, -0.026541922241449356, 0.014297728426754475, -0.024783585220575333, -0.003551971400156617, 0.011628134176135063, -0.0037252383772283792, 0.05277581512928009, -0.013412141241133213, -0.007026935461908579, -0.047231275588274, -0.006693236064165831, 0.016518112272024155, 0.0017326690722256899, 0.02459106594324112, 0.021061554551124573, -0.007488980423659086, -0.027106644585728645, -0.0264649149030447, 0.005175546742975712, 0.010755382478237152, 0.015234652906656265, 0.011705141514539719, 0.008483661338686943, -0.008855863474309444, 0.03372928872704506, 0.0034877986181527376, -0.008092205971479416, -0.0036225616931915283, -0.004453601315617561, 0.012250611558556557, -0.037528328597545624, 0.008740352466702461, 0.009844127111136913, -0.0085670854896307, 0.015324494801461697, -0.006083593238145113, 0.011615299619734287, -0.0009794392390176654, -0.011037743650376797, 0.0036193530540913343, -0.022511862218379974, 0.017390863969922066, -0.024270201101899147, -0.004277125466614962, 0.0014037827495485544, -0.004180866293609142, -0.0029278898146003485, -0.022280840203166008, 0.02575901336967945, -0.015927720814943314, -0.003065861528739333, 0.009054799564182758, -0.028287425637245178, 0.018635818734765053, 0.01674913428723812, -0.0020118211396038532, 0.023692645132541656, 0.00021738579380325973, -0.012584310956299305, -0.018635818734765053, 0.02388516254723072, -0.019932111725211143, 0.008329645730555058, 0.013566156849265099, 0.0010460186749696732, -0.008380983956158161, 0.004135945346206427, -0.007886853069067001, -0.008156378753483295, 0.009831292554736137, -0.03378062695264816, -0.0015666215913370252, -0.03817005828022957, 0.017557712271809578, 0.009035548195242882, 0.009189562872052193, 0.011108333244919777, 0.0024498014245182276, -0.011044160462915897, -0.014207885600626469, -0.015773706138134003, -0.015760870650410652, 0.006789495702832937, 0.04214878007769585, 0.013181119225919247, 0.0016668917378410697, 0.005056826863437891, 0.029519546777009964, -0.02990458346903324, 0.009266570210456848, -0.0022332179360091686, 0.01244954764842987, 0.02859545685350895, 0.002672802424058318, 0.02030431479215622, 0.006693236064165831, -0.02203698270022869, 0.025078779086470604, 0.010973570868372917, 0.0772128626704216, -0.0017679641023278236, 0.0032006248366087675, -0.00908046867698431, 0.00021377606026362628, -0.004617242142558098, -0.07387587428092957, -0.026978299021720886, 0.016530945897102356, 4.5046384911984205e-05, -0.014554419554769993, 0.04094232618808746, 0.01066554058343172, 0.021138561889529228, 0.0002205944329034537, 0.024488389492034912, -0.00041190997580997646, -0.029365532100200653, 0.005721016321331263, -0.023076584562659264, 0.027517350390553474, -0.026516253128647804, -0.001540150260552764, 0.0006192687433212996, -0.013681667856872082, 0.006821582093834877, 0.00972861610352993, -0.03462770953774452, 0.0032295025885105133, -0.019559908658266068, -0.011499788612127304, -0.0035295109264552593, -0.029930252581834793, 0.02215249463915825, 0.025091614574193954, -0.013964029029011726, -0.004145571030676365, -0.011705141514539719, 0.004906020127236843, -0.018276449292898178, -0.008605589158833027, -0.0032984884455800056, -0.022280840203166008, -0.01009440142661333, 0.0011527062160894275, -0.0271836519241333, 0.014066705480217934, 0.007379886694252491, -0.005961664952337742, -0.02288406528532505, 0.006596976891160011, -0.014580088667571545, -0.01973959244787693, 0.011666637845337391, 0.007219454273581505, -0.016684960573911667, -0.023564299568533897, 0.0018016549292951822, -0.02158777229487896, 0.009767119772732258, 0.010492273606359959, -0.008772439323365688, -0.0023583550937473774, 0.004408679902553558, -0.02360280230641365, -0.015491344965994358, 0.012032424099743366, -0.0015208983095362782, -0.014990795403718948, -0.009138224646449089, 0.016980156302452087, -0.011827070266008377, 0.0009409355116076767, -0.02133108116686344, 0.032266147434711456, -0.010588533245027065, -0.023204930126667023, 0.01021633017808199, -0.0221781637519598, 0.01714700646698475, -0.017352359369397163, 0.02946820855140686, -0.024809254333376884, -0.026387907564640045, 0.007777758873999119, -0.04032626748085022, 0.0008262264309450984, -0.03413999825716019, 0.0024273409508168697, -0.0006581735797226429, 0.03760533407330513, 0.017840074375271797, 0.007970277220010757, 0.013373637571930885, 0.015555517747998238, -0.011820653453469276, 0.000385037565138191, 0.037425652146339417, 0.012378957122564316, -0.018545975908637047, -0.00985696166753769, -0.005342395976185799, -0.020702186971902847, -0.005875031463801861, -0.009414168074727058, 0.0023342901840806007, -0.012847419828176498, 0.004498522263020277, -0.07777758687734604, 0.008830194361507893, 0.01085805892944336, 0.021703284233808517, 0.003763742046430707, -0.008701848797500134, -0.014426073990762234, 0.025836020708084106, 0.009606687352061272, 0.010408848524093628, -0.02044549398124218, 0.014515915885567665, 0.020843366160988808, -0.0037701595574617386, -0.03963319957256317, 0.014708435162901878, 0.016056066378951073, -0.004485687706619501, 0.015966223552823067, -0.00979920569807291, -0.0243087038397789, 0.001295491005294025, 0.009876213036477566, 2.985545143019408e-05, 0.01286667212843895, 0.021356750279664993, -0.01599189266562462, 0.004174449015408754, -0.014118043705821037, -0.01522181835025549, 0.0022235920187085867, -0.013386472128331661, -0.021138561889529228, 0.028287425637245178, -0.014759773388504982, -0.03932517021894455, 0.016081735491752625, 0.018481802195310593, 0.01015857420861721, 0.018391961231827736, -0.014041036367416382, -0.03401165083050728, 0.00403647730126977, -0.028544118627905846, 0.0023262687027454376, 0.01343781128525734, -0.012346871197223663, -0.007918938994407654, -0.006497508846223354, -0.008766021579504013, 0.0058333189226686954, 0.006532804109156132, -0.012122265994548798, -0.018815502524375916, 0.008900784887373447, -0.020355653017759323, 0.028569787740707397, -0.015285991132259369, -0.0038022459484636784, 0.00010428100358694792, 0.016992991790175438, 0.039838552474975586, 0.0013636746443808079, -0.01603039726614952, -0.012776829302310944, -0.009690111503005028, 0.004816178232431412, 0.005746685434132814, 0.00539373466745019, -0.03370362147688866, -0.021818794310092926, 0.016838975250720978, -0.008400236256420612, 0.02402634359896183, 0.014143712818622589, -0.00028476736042648554, 0.007238706108182669, 0.011839904822409153, -0.0056793042458593845, 0.02659326046705246, 0.005031157284975052, 0.004514565225690603, -0.019341720268130302, 0.025219960138201714, -0.018802667036652565, 0.02157493866980076, -0.006311407312750816, 0.015914885327219963, -0.0017438993090763688, -0.0021642318461090326, -0.027851050719618797, -0.00223161350004375, -0.00400759931653738, -0.0004443975049071014, -0.006596976891160011, 0.03675825148820877, 0.004190491978079081, -0.009619521908462048, 0.017121337354183197, 0.016364095732569695, 0.0036771087907254696, -0.006375580094754696, -0.02332044206559658, -0.02389799803495407, -0.021048719063401222, 0.0399925671517849, -0.013059190474450588, -0.010164991952478886, 0.016774803400039673, 0.02661892957985401, 0.014695600606501102, 0.01685181073844433, -0.004427931737154722, 0.016364095732569695, -0.025142952799797058, 0.0009818457765504718, 0.004976610653102398, -0.010396013967692852, -0.01136502530425787, 0.033267244696617126, 0.02185729891061783, 0.01515764556825161, 0.016210081055760384, -0.009536096826195717, 0.012674152851104736, 0.025515155866742134, 0.007514649536460638, -0.03786202520132065, 0.016068900004029274, -0.021241238340735435, 0.02315359190106392, -0.0016733090160414577, -0.021100059151649475, 0.0015425566816702485, -0.010293337516486645, 0.005111373495310545, 8.929061004891992e-05, 0.006584142334759235, -0.020355653017759323, 0.06407024711370468, 0.010691209696233273, -0.003277632175013423, 0.022062651813030243, -0.02900616265833378, 0.01875132881104946, 0.01614590920507908, -0.004257873632013798, -0.012346871197223663, 0.006532804109156132, 0.008952123112976551, 0.0056857215240597725, 0.005124208051711321, -0.010023810900747776, -0.029930252581834793, -0.015234652906656265, 0.0021642318461090326, 0.008618423715233803, -0.022422021254897118, -0.003645022166892886, -0.0017519209068268538, 0.006375580094754696, 0.019072193652391434, 0.002570125740021467, -0.011794984340667725, 0.021266907453536987, 0.008457991294562817, 0.00010638668027240783, 0.0019540656358003616, -0.014349066652357578, 0.0001872044667834416, 0.0034332515206187963, -0.014066705480217934, -0.0030065015889704227, 0.036527231335639954, -0.013046355918049812, -0.0011871991446241736, -0.011743645183742046, -0.0034332515206187963, 0.02471941150724888, -0.021254073828458786, 0.007309296168386936, -0.018199441954493523, -0.025784682482481003, 0.022640207782387733, 0.007315713446587324, -0.00880452524870634, -0.021703284233808517, -0.003645022166892886]

        relevance_out = dict()
        for count, node in enumerate(nodes):
            node_embedding = persona.associative_memory.embeddings[node.embedding_key]
            relevance_out[node.node_id] = self.cos_sim(node_embedding, focal_embedding)

        return relevance_out