"""
Author: Joon Sung Park (joonspk@stanford.edu)

File: retrieve.py
Description: This defines the "Retrieve" module for generative agents. 
"""
import sys
sys.path.append('../../')

from global_methods import *
from persona.prompt_template.gpt_structure import *

from numpy import dot
from numpy.linalg import norm

def retrieve(persona, perceived): 
  """
  This function takes the events that are perceived by the persona as input
  and returns a set of related events and thoughts that the persona would 
  need to consider as context when planning. 

  INPUT: 
    perceived: a list of event <ConceptNode>s that represent any of the events
    `         that are happening around the persona. What is included in here
              are controlled by the att_bandwidth and retention 
              hyper-parameters.
  OUTPUT: 
    retrieved: a dictionary of dictionary. The first layer specifies an event, 
               while the latter layer specifies the "curr_event", "events", 
               and "thoughts" that are relevant.
  """
  # We rerieve events and thoughts separately. 
  retrieved = dict()
  for event in perceived: 
    retrieved[event.description] = dict()
    retrieved[event.description]["curr_event"] = event
    
    relevant_events = persona.a_mem.retrieve_relevant_events(
                        event.subject, event.predicate, event.object)
    retrieved[event.description]["events"] = list(relevant_events)

    relevant_thoughts = persona.a_mem.retrieve_relevant_thoughts(
                          event.subject, event.predicate, event.object)
    retrieved[event.description]["thoughts"] = list(relevant_thoughts)
    
  return retrieved


def cos_sim(a, b): 
  """
  This function calculates the cosine similarity between two input vectors 
  'a' and 'b'. Cosine similarity is a measure of similarity between two 
  non-zero vectors of an inner product space that measures the cosine 
  of the angle between them.

  INPUT: 
    a: 1-D array object 
    b: 1-D array object 
  OUTPUT: 
    A scalar value representing the cosine similarity between the input 
    vectors 'a' and 'b'.
  
  Example input: 
    a = [0.3, 0.2, 0.5]
    b = [0.2, 0.2, 0.5]
  """
  return dot(a, b)/(norm(a)*norm(b))


def normalize_dict_floats(d, target_min, target_max):
  """
  This function normalizes the float values of a given dictionary 'd' between 
  a target minimum and maximum value. The normalization is done by scaling the
  values to the target range while maintaining the same relative proportions 
  between the original values.

  INPUT: 
    d: Dictionary. The input dictionary whose float values need to be 
       normalized.
    target_min: Integer or float. The minimum value to which the original 
                values should be scaled.
    target_max: Integer or float. The maximum value to which the original 
                values should be scaled.
  OUTPUT: 
    d: A new dictionary with the same keys as the input but with the float
       values normalized between the target_min and target_max.

  Example input: 
    d = {'a':1.2,'b':3.4,'c':5.6,'d':7.8}
    target_min = -5
    target_max = 5
  """
  min_val = min(val for val in d.values())
  max_val = max(val for val in d.values())
  range_val = max_val - min_val

  if range_val == 0: 
    for key, val in d.items(): 
      d[key] = (target_max - target_min)/2
  else: 
    for key, val in d.items():
      d[key] = ((val - min_val) * (target_max - target_min) 
                / range_val + target_min)
  return d


def top_highest_x_values(d, x):
  """
  This function takes a dictionary 'd' and an integer 'x' as input, and 
  returns a new dictionary containing the top 'x' key-value pairs from the 
  input dictionary 'd' with the highest values.

  INPUT: 
    d: Dictionary. The input dictionary from which the top 'x' key-value pairs 
       with the highest values are to be extracted.
    x: Integer. The number of top key-value pairs with the highest values to
       be extracted from the input dictionary.
  OUTPUT: 
    A new dictionary containing the top 'x' key-value pairs from the input 
    dictionary 'd' with the highest values.
  
  Example input: 
    d = {'a':1.2,'b':3.4,'c':5.6,'d':7.8}
    x = 3
  """
  top_v = dict(sorted(d.items(), 
                      key=lambda item: item[1], 
                      reverse=True)[:x])
  return top_v


def extract_recency(persona, nodes):
  """
  Gets the current Persona object and a list of nodes that are in a 
  chronological order, and outputs a dictionary that has the recency score
  calculated.

  INPUT: 
    persona: Current persona whose memory we are retrieving. 
    nodes: A list of Node object in a chronological order. 
  OUTPUT: 
    recency_out: A dictionary whose keys are the node.node_id and whose values
                 are the float that represents the recency score. 
  """
  recency_vals = [persona.scratch.recency_decay ** i 
                  for i in range(1, len(nodes) + 1)]
  
  recency_out = dict()
  for count, node in enumerate(nodes): 
    recency_out[node.node_id] = recency_vals[count]

  return recency_out


def extract_importance(persona, nodes):
  """
  Gets the current Persona object and a list of nodes that are in a 
  chronological order, and outputs a dictionary that has the importance score
  calculated.

  INPUT: 
    persona: Current persona whose memory we are retrieving. 
    nodes: A list of Node object in a chronological order. 
  OUTPUT: 
    importance_out: A dictionary whose keys are the node.node_id and whose 
                    values are the float that represents the importance score.
  """
  importance_out = dict()
  for count, node in enumerate(nodes): 
    importance_out[node.node_id] = node.poignancy

  return importance_out


def extract_relevance(persona, nodes, focal_pt): 
  """
  Gets the current Persona object, a list of nodes that are in a 
  chronological order, and the focal_pt string and outputs a dictionary 
  that has the relevance score calculated.

  INPUT: 
    persona: Current persona whose memory we are retrieving. 
    nodes: A list of Node object in a chronological order. 
    focal_pt: A string describing the current thought of revent of focus.  
  OUTPUT: 
    relevance_out: A dictionary whose keys are the node.node_id and whose values
                 are the float that represents the relevance score. 
  """
  # focal_embedding = get_embedding(focal_pt)
  
  focal_embedding = [-3.810749331023544e-05, -0.015995889902114868, 0.01143409963697195, -0.03236041218042374, -0.031781136989593506, 0.030069641768932343, -0.027278589084744453, -0.0006138340686447918, -0.005387916229665279, -0.011763233691453934, 0.028884761035442352, 0.0038344059139490128, 0.009498794563114643, -0.004851428791880608, -0.006447726394981146, -0.016193371266126633, 0.026027880609035492, -0.014745183289051056, 0.0040055555291473866, -0.02049843780696392, -0.012553153559565544, 0.009347393177449703, 0.010769249871373177, -0.0053352550603449345, -0.0002581641310825944, -0.00581579003483057, 0.011776398867368698, -0.029990648850798607, -0.01158550102263689, -0.00703687546774745, 0.01664099283516407, -0.003353870939463377, -0.029042745009064674, -0.01050594262778759, -0.01624603196978569, 0.01155258808284998, 0.009281566366553307, -0.016193371266126633, 0.014863671734929085, 0.018931761384010315, -0.0017279511084780097, -0.006217333022505045, 0.012744051404297352, -0.04934370145201683, -0.021551664918661118, 0.022486403584480286, 0.017588896676898003, 0.008932684548199177, -0.00558868795633316, 0.018786942586302757, 0.037363242357969284, 0.03375593572854996, -0.0034065323416143656, -0.000856570084579289, -0.0024816670920699835, -0.01803651824593544, 0.007326513063162565, -0.004031885880976915, -0.0264491718262434, -0.02835814654827118, 0.007392339874058962, -0.00921573955565691, -0.01845780946314335, -0.008735204115509987, -0.009775266982614994, -0.016838472336530685, -0.01020313985645771, 0.03446686640381813, 0.003956185188144445, 0.004894216079264879, 0.0129941925406456, 0.040917884558439255, -0.00871545635163784, -0.02280237339437008, 0.03918005898594856, -0.001253998838365078, -0.011322194710373878, 0.003936437424272299, -0.015140143223106861, -0.016891134902834892, 0.016469843685626984, -0.007616150658577681, -0.02835814654827118, 0.01627236232161522, 0.00959753431379795, 0.01569308713078499, 0.008524559438228607, 0.014389718882739544, -0.017931196838617325, -0.0007734638638794422, -0.009294731542468071, 0.021459508687257767, 0.005292467772960663, 0.014192238450050354, -0.0045716650784015656, 0.009827927686274052, -0.02914806827902794, 0.01113129686564207, 0.0008730267290957272, -0.031412508338689804, 0.025132637470960617, -0.003072461811825633, -0.017325589433312416, -0.010545439086854458, -0.028015848249197006, -0.005094987340271473, 6.207253318279982e-05, 0.0019369509536772966, -0.004551916848868132, -0.005680845119059086, -0.011276115663349628, 0.01228326465934515, 0.0033308316487818956, -0.0421554259955883, -0.0025129346176981926, -0.03683662787079811, 0.010407202877104282, -0.03322932496666908, 0.0031086665112525225, -0.01740458235144615, 0.023908261209726334, 0.012513658031821251, -0.001466289977543056, -0.025277456268668175, 0.010624431073665619, 0.023644953966140747, -0.021946625784039497, -0.006786733865737915, -0.0028206745628267527, 0.002967139007523656, 0.0187342818826437, 0.007662229239940643, 0.009090668521821499, -0.003289689775556326, -0.010762667283415794, 0.010795580223202705, -0.009485629387199879, 0.010374289937317371, -0.004752688575536013, -0.010058321058750153, 0.015219135209918022, 0.015903733670711517, -0.008557472378015518, -0.01161183137446642, 0.004278736189007759, 0.001719722873531282, 0.0004776550631504506, 0.00561830960214138, 0.005183853674679995, -0.009729187935590744, 0.0122371856123209, -0.023908261209726334, 0.01912924274802208, -0.004124043509364128, 0.0058783250860869884, -0.003791618626564741, -0.011815894395112991, 0.03322932496666908, -0.029200728982686996, -0.019629525020718575, -0.013942097313702106, -0.011414351873099804, 0.0010705068707466125, -0.00424253148958087, 0.007958449423313141, 0.030201295390725136, 0.002037336817011237, 0.015719419345259666, 0.0005726923700422049, -0.009808179922401905, 0.013994758948683739, 0.04457784816622734, -0.014995324425399303, 0.02647550404071808, -0.021459508687257767, 0.005792750511318445, -0.0036204690113663673, 0.012368839234113693, -0.02772621065378189, -0.008886606432497501, -0.011032557114958763, 0.007958449423313141, 0.004976499360054731, 0.0014309081016108394, 0.010268966667354107, 0.026370180770754814, 0.014797844924032688, -0.017654724419116974, -0.006069222930818796, -0.004960042890161276, 0.009255236014723778, 0.013448396697640419, -0.007675394415855408, -0.02326316013932228, -0.6904958486557007, -0.0021558247972279787, 0.006289742421358824, 0.024000419303774834, -0.019971823319792747, 0.02271021530032158, 0.0151533093303442, -0.009426385164260864, -0.0015024946769699454, 0.015587764792144299, 0.000901003135368228, 0.013066601939499378, 0.004387350287288427, -0.012256933376193047, -0.02687046304345131, -0.009617282077670097, -0.01467935647815466, -0.013665624894201756, 0.00906433816999197, 0.009617282077670097, 0.00947246327996254, 0.00974893569946289, 0.004627618007361889, -0.012467578984797001, -0.004943585954606533, -0.01334307435899973, 0.008656212128698826, -0.016404015943408012, -0.0002373875759076327, -0.007846543565392494, -0.0227760411798954, 0.0229603573679924, -0.022328419610857964, 0.005216766614466906, 0.053424958139657974, -0.013810443691909313, -0.005308924242854118, 0.02149900421500206, 0.0018991006072610617, 0.03212343528866768, -0.013158759102225304, -0.006480639800429344, 0.02672564424574375, 0.010005660355091095, -0.006533300969749689, 0.019905997440218925, 0.01117737591266632, -0.0072343554347753525, -0.02350013516843319, 0.005499821621924639, -0.003972642123699188, -0.00806377176195383, 0.004907381255179644, 0.025224795565009117, 0.009307896718382835, 0.00012116228754166514, -0.012658476829528809, -0.00737917423248291, -0.021248862147331238, 0.010815328918397427, -0.013942097313702106, 0.009149912744760513, -0.02265755459666252, 0.0019896123558282852, -0.008794448338449001, 0.005707175936549902, -0.03212343528866768, -0.010453281924128532, -0.0013864750508219004, -0.007214607670903206, 0.001452301861718297, 0.016891134902834892, -0.00826125219464302, -0.022038782015442848, 0.015864238142967224, 0.010690257884562016, 0.008491645567119122, -0.0007574185729026794, 0.011025974527001381, -0.003046130994334817, -0.017088614404201508, -0.03164948150515556, -0.004755979869514704, 0.013902601785957813, 0.02082757093012333, -0.011664493009448051, -0.030648916959762573, 0.00604289211332798, -0.017325589433312416, -0.007458166219294071, 0.03204444423317909, 0.027910524979233742, -0.010729754343628883, -0.010736336931586266, -0.0025573677849024534, 0.019260896369814873, -0.016904300078749657, 0.007438418455421925, 0.02128835767507553, -0.037942517548799515, 0.005299050360918045, -0.015403450466692448, 0.008840527385473251, 0.0007475445745512843, 0.0011198768625035882, 0.018905431032180786, -0.031175529584288597, 0.0033620991744101048, 0.02544860728085041, -0.019682185724377632, 0.004170122090727091, 0.022157270461320877, 0.0068262298591434956, -0.02972734346985817, 0.00020539990509860218, -0.03243940323591232, 0.012151611037552357, -0.005888199433684349, -0.00020704558119177818, -0.026014715433120728, 0.0068459780886769295, 0.0022792499512434006, 0.01645667850971222, -0.007050040643662214, 0.0033769102301448584, 0.016022222116589546, -0.011144462041556835, -0.015403450466692448, -0.017839038744568825, 0.0024750842712819576, 0.01417907327413559, 0.00768197700381279, 0.02830548584461212, -0.02001132071018219, 0.009926668368279934, -0.009426385164260864, 0.01457403413951397, 0.003943020012229681, 0.005437286105006933, 0.003220571903511882, -0.027620887383818626, -0.016298694536089897, -0.00810985080897808, 0.002032399643212557, 0.005536026321351528, -0.015719419345259666, -0.005855286028236151, 0.004953459836542606, -0.008662794716656208, 0.014047420583665371, -0.012098949402570724, -8.624327892903239e-05, 0.013652459718286991, 0.0031629735603928566, 0.011526256799697876, -0.023539632558822632, -0.005308924242854118, -0.023526467382907867, -0.030964884907007217, -0.04397224262356758, 0.00215911609120667, 0.023789772763848305, -0.02031412348151207, -0.001212857197970152, 0.010064903646707535, 0.007622733246535063, 0.015508772805333138, -0.0022529191337525845, -0.014047420583665371, -0.020485272631049156, 0.019458375871181488, -0.012908617965877056, 0.01050594262778759, -0.01566675677895546, -0.009077503345906734, -0.008280999958515167, -0.023881930857896805, -0.0022364624310284853, -0.024816669523715973, 0.009340810589492321, 0.007945284247398376, -0.0038014925085008144, -0.006069222930818796, 0.0011470303870737553, 0.018352486193180084, 0.020669586956501007, -0.001336282235570252, 0.027094274759292603, -3.799178330154973e-06, 0.000333042029524222, -0.003906815312802792, 0.016298694536089897, -0.00570059334859252, -0.0019237856613472104, -0.01691746525466442, 0.006684702355414629, 0.0043149408884346485, 0.014495042152702808, 0.013915766961872578, 0.011842225678265095, 0.007945284247398376, -0.01812867633998394, 0.0303066186606884, -0.002805863507091999, 0.005075239576399326, -0.04236607253551483, 0.004324814770370722, -0.02107771299779415, 0.018563132733106613, 0.02180180698633194, 0.017167605459690094, -0.03135984390974045, -0.023276325315237045, -0.013066601939499378, 0.017101779580116272, 0.010788997635245323, -0.0063127814792096615, -0.0022973523009568453, -0.0034624850377440453, -0.006911804433912039, 0.00886685773730278, 0.009577786549925804, 0.02207827940583229, -0.00020869124273303896, 0.007523993030190468, 0.01803651824593544, -0.009255236014723778, 0.0034065323416143656, 0.01055202167481184, -0.004693444352596998, -0.0006924147019162774, -0.0007101056398823857, 0.0023302654735744, -0.0006784265278838575, 0.018839605152606964, 0.0013979948125779629, -0.0006393419462256134, -0.020393114537000656, 0.015482442453503609, 0.004512420855462551, 0.008142763748764992, 0.03996998071670532, 0.006628749892115593, 0.006530009675770998, 0.027304919436573982, -0.012256933376193047, 0.030438270419836044, -0.0040022642351686954, -0.0012934948317706585, 0.010874572210013866, -0.01296786218881607, 0.006786733865737915, 0.00768197700381279, -0.009228904731571674, 0.03465117886662483, -0.02213094010949135, 0.0013280538842082024, 0.011262950487434864, 0.019853336736559868, 0.00807693786919117, 0.008926101960241795, 0.004252405371516943, 0.00023080490063875914, -0.00733967823907733, 0.015982724726200104, -0.0030675246380269527, -0.005269428249448538, -0.00489750737324357, 0.0004817692388314754, -0.017325589433312416, -0.005473490804433823, -0.005766419693827629, 0.010815328918397427, -0.006447726394981146, 0.00561830960214138, -0.016785811632871628, -0.0038870673161000013, 0.02198612131178379, 0.010328210890293121, 0.012112114578485489, -0.023908261209726334, -0.024974653497338295, 0.010459864512085915, 0.01161183137446642, 0.004795475862920284, -0.03380860015749931, -0.008643046952784061, -0.0111576272174716, -0.022578561678528786, -0.007043458055704832, -0.009485629387199879, 0.002075187163427472, -0.008149347268044949, -0.0060560572892427444, -0.017009621486067772, -0.009571203961968422, 0.006286451127380133, -0.023974088951945305, 0.011684240773320198, -0.006523427087813616, -0.007464748807251453, -0.003758705221116543, 0.007445001043379307, 0.005453743040561676, 0.03233408182859421, 0.018589463084936142, -0.006753820460289717, -0.013823608867824078, 0.0070566232316195965, -0.009906919673085213, 0.005977065302431583, -0.0060593485832214355, -0.019774343818426132, -0.0003030085645150393, -0.004838263150304556, 0.011624997481703758, 0.008643046952784061, -0.028568793088197708, -0.0016481362981721759, 0.011750067584216595, 0.006793316453695297, -0.012197689153254032, -0.013757782988250256, -0.004087838809937239, 0.07625366002321243, 0.03999631106853485, 0.00044803303899243474, 0.039522357285022736, 0.011690824292600155, -0.0035710991360247135, -0.019695352762937546, -0.044867485761642456, 0.016930630430579185, -0.000202519993763417, -0.013652459718286991, -0.013849940150976181, -0.012612397782504559, 0.0165751650929451, 0.03570440784096718, 0.001044998993165791, 0.005677553825080395, -0.001956698950380087, 0.0027350997552275658, 0.019458375871181488, -0.0030790443997830153, 0.015245466493070126, 0.009966163896024227, 0.04302433878183365, 0.0172202680259943, -0.015956394374370575, 0.01745724305510521, 0.02396092191338539, 0.008202007971704006, -0.012270098552107811, 0.008103268221020699, 0.01854996755719185, 0.04162881150841713, 0.004298484418541193, -0.02638334594666958, 0.005963900126516819, -0.0028486510273069143, -0.003929854836314917, 0.0030198004096746445, 0.003449319628998637, 0.011947548016905785, 0.005638057831674814, -0.005111444275826216, -0.022486403584480286, 0.020761745050549507, -0.0333346463739872, -0.01273746881633997, 0.01994549296796322, 0.008906354196369648, -0.016167040914297104, 0.028595123440027237, -0.013079767115414143, -0.011618414893746376, -0.003952893894165754, 0.013283830136060715, 0.017878534272313118, -0.0014950891491025686, 0.00986742414534092, -0.004443303216248751, 0.017193937674164772, -0.024921992793679237, -0.011973878368735313, -0.003446028335019946, -0.016930630430579185, 0.008695708587765694, -0.01014389656484127, -0.000565286900382489, 0.010867989622056484, -0.04889608174562454, -0.025790905579924583, 0.022552231326699257, -0.0008039086824283004, -0.0372842475771904, 0.012322760187089443, 0.022446908056735992, 0.008162512443959713, 0.026699313893914223, -0.021630657836794853, 0.0036500911228358746, 0.01128269825130701, -0.015008490532636642, -0.024303222075104713, -0.003933146130293608, -0.023368481546640396, -0.014047420583665371, -0.006381899584084749, -0.008550889790058136, 0.007629315834492445, -0.005496530327945948, 0.02796318754553795, -0.003943020012229681, 0.0038442800287157297, -0.006464182864874601, -0.03146516904234886, -0.012066036462783813, -0.009242069907486439, 0.03788985311985016, 0.027673549950122833, -0.010268966667354107, 0.002514580264687538, 0.0069776312448084354, -0.03441420570015907, -0.007214607670903206, -0.012954697012901306, -0.02338164858520031, 0.00015860123676247895, -0.008169095031917095, 0.021907130256295204, 0.0025096433237195015, 0.01961635984480381, 0.03504614159464836, -0.020169304683804512, 0.004124043509364128, -0.01273746881633997, -0.0010392392287030816, 0.02170964889228344, -0.007813630625605583, 0.01870795153081417, 0.008037441410124302, 0.005193727556616068, 0.0040582166984677315, -0.02912173606455326, 0.032176095992326736, 0.036389004439115524, 0.028674114495515823, 0.016167040914297104, -0.0018480849685147405, 0.0015888921916484833, 0.009334228001534939, -0.006852560676634312, -0.005480073858052492, 0.0150611512362957, -0.004907381255179644, -0.0006031372467987239, -0.01573258452117443, -0.014547702856361866, -0.025093141943216324, 0.029411373659968376, -0.004657239653170109, -0.004667114000767469, -0.003148162504658103, 0.0007051686407066882, -0.003989098593592644, -0.018418313935399055, 0.019603194668889046, -0.01894492655992508, -0.026804637163877487, 0.019300391897559166, -0.008327079005539417, 0.014942663721740246, -0.018931761384010315, 0.0007714067469350994, -0.006418104283511639, 0.001610285951755941, -0.0036533824168145657, -0.02875310741364956, -0.005819081328809261, -0.007853127084672451, 0.031807467341423035, 0.01242149993777275, 0.004565082490444183, 0.01578524522483349, 0.00891293678432703, 0.014165908098220825, -0.01573258452117443, -0.004499255679547787, -0.0039594764821231365, 0.02010347694158554, -0.03494081646203995, 0.021933460608124733, -0.005045617464929819, -0.005697302054613829, 0.014942663721740246, 0.009070920757949352, 0.001486860797740519, -0.011526256799697876, -0.006533300969749689, 0.009577786549925804, -0.0019237856613472104, -0.005819081328809261, -0.007221190258860588, -0.014890002086758614, -0.007247521076351404, 0.003775161923840642, -0.004133917391300201, 0.003919980488717556, 0.029569359496235847, 0.00619429349899292, -0.002052147639915347, 0.005828955210745335, 0.015192804858088493, -0.04260304570198059, 0.019576864317059517, -0.0067998990416526794, -0.005871742498129606, -0.018786942586302757, 0.009189409203827381, 0.0012375421356409788, 0.0036402170080691576, 0.024540197104215622, 0.016746316105127335, -0.012033122591674328, -0.016167040914297104, 0.001589715015143156, -0.013303577899932861, 0.013849940150976181, 0.0025606590788811445, -0.012981027364730835, 0.005921112839132547, -0.03186012804508209, -0.015521938912570477, -0.013349656946957111, -0.009426385164260864, -0.01803651824593544, 0.013691956177353859, 0.00470660999417305, -0.0059244041331112385, 0.013665624894201756, -0.0027285171672701836, -0.008090103045105934, -0.003271587425842881, -0.004199744202196598, 0.040101632475852966, 0.011420934461057186, 0.03454585745930672, 0.02617269940674305, -0.016088047996163368, -0.005562357138842344, -0.006286451127380133, 0.022512735798954964, -0.015166474506258965, -0.0014819238567724824, 0.01269138976931572, -0.011927800253033638, -0.015219135209918022, -0.0011256367433816195, 0.012572902254760265, 0.012322760187089443, -0.008583802729845047, 0.020208800211548805, 0.007701725233346224, 0.004031885880976915, -0.007063206285238266, -0.022236263379454613, 0.003518437733873725, -0.003154745092615485, -0.031412508338689804, 0.002353304997086525, -0.023184167221188545, -0.043313976377248764, -0.018931761384010315, 0.03322932496666908, -0.016930630430579185, -0.0018250455614179373, -0.003936437424272299, -0.014942663721740246, 0.036389004439115524, -0.02396092191338539, 0.013171925209462643, 0.007346260827034712, -0.020050816237926483, 0.05018628388643265, 0.005911238491535187, 0.002911186311393976, -0.012019957415759563, 0.0036336344201117754, -0.0075898198410868645, -0.0021097459830343723, -0.0074120876379311085, 0.017325589433312416, -0.022460073232650757, -0.012757216580212116, -0.012711137533187866, -0.02077491022646427, 0.016772646456956863, -0.012625562958419323, -0.007899205200374126, -0.010519108735024929, 0.010308463126420975, -0.005447160452604294, 0.012256933376193047, -0.004838263150304556, -0.014718852937221527, -0.014639860950410366, -0.012849373742938042, -0.010479612275958061, -0.016390850767493248, 0.00974893569946289, 0.02201245166361332, -0.030359279364347458, -0.022341584786772728, -0.012981027364730835, 0.02173597924411297, -0.00535171153023839, -0.00986742414534092, -0.014297561720013618, -0.007017127238214016, 0.028884761035442352, -0.019761178642511368, -0.003459193743765354, 0.009920085780322552, -0.01785220392048359, -0.01569308713078499, 0.014811010099947453, 0.015350788831710815, -0.016785811632871628, 0.014587199315428734, -0.00558868795633316, -0.02338164858520031, 0.006971048656851053, -0.02519846521317959, -0.006905221845954657, 0.00020704558119177818, -0.017483575269579887, -0.012256933376193047, 0.012138445861637592, 0.016956960782408714, -0.018536802381277084, 0.0223152544349432, 0.03681029751896858, -0.013639294542372227, -0.008656212128698826, -0.013402318581938744, -0.022815538570284843, 0.004354436881840229, 0.037968847900629044, -0.0007471331628039479, 0.028226492926478386, -0.03978566452860832, -0.0037982012145221233, 0.01208578422665596, 0.01731242425739765, -0.006223915610462427, -0.0020570848137140274, -0.014468710869550705, -0.006852560676634312, -0.0030296742916107178, -0.004752688575536013, -0.0040022642351686954, 0.003107020864263177, -0.006951300892978907, 0.012460996396839619, 0.002024171408265829, 0.015653591603040695, -0.02152533456683159, -0.009920085780322552, -0.00994641613215208, -0.022038782015442848, -0.0034229890443384647, -0.020261460915207863, -0.01718077063560486, 0.0003497044090181589, 0.010459864512085915, -0.013863105326890945, -0.005983647890388966, 0.02417156845331192, -0.011967295780777931, 0.0044136811047792435, -0.008616716600954533, 0.012460996396839619, 0.011638162657618523, 0.011769816279411316, -0.01724659837782383, 0.021459508687257767, 0.012836208567023277, 0.02854246273636818, -0.00011519674444571137, -0.01685163751244545, 0.02568558230996132, 0.005572231020778418, 0.020906563848257065, -0.004403806757181883, -0.019761178642511368, 0.012184523977339268, 0.022999852895736694, 0.008011111058294773, -0.010315045714378357, -0.003100438043475151, -0.01100622583180666, -0.01249390933662653, 0.014929497614502907, 0.007820213213562965, -0.0060560572892427444, 0.0075898198410868645, 0.030885891988873482, -0.03143883869051933, -0.007431835867464542, -0.001035124994814396, 0.0037850358057767153, -0.019471541047096252, -0.006533300969749689, 0.013915766961872578, -0.01715444028377533, 0.001983029767870903, 0.016983291134238243, 0.011894886381924152, 0.004894216079264879, -0.024829834699630737, 0.021604325622320175, 0.008583802729845047, 0.02638334594666958, 0.0171281099319458, -0.004709901288151741, 0.0011396249756217003, -0.018971258774399757, 0.0015386993763968349, -0.047658540308475494, -0.01627236232161522, 0.007925535552203655, -0.01243466604501009, 0.019116077572107315, 0.0002785292745102197, 0.004597995895892382, -0.009847676381468773, 0.021459508687257767, -0.042313408106565475, -0.00630949018523097, -0.0025985094252973795, 0.001027719466947019, 0.012823043391108513, -0.04297167807817459, 0.0188264399766922, -0.012092366814613342, -0.001956698950380087, -0.0025343282613903284, 0.0031629735603928566, -0.01724659837782383, -0.00828758254647255, -0.01998499035835266, 0.013612964190542698, -0.003302855184301734, 0.020537933334708214, 0.006000104825943708, -0.007971614599227905, -0.018286660313606262, 0.030464602634310722, 0.2287609875202179, -0.0075700716115534306, -0.0111576272174716, 0.03470384329557419, -0.007352843414992094, 0.003689587116241455, 0.011513091623783112, 0.006878891494125128, 0.005499821621924639, 0.013915766961872578, 0.004268862307071686, -0.010361124761402607, 0.01153942197561264, -0.0015436363173648715, -0.00011313965660519898, 0.0033736189361661673, -0.040285948663949966, -0.03143883869051933, 0.004680279176682234, -0.02517213486135006, 0.011690824292600155, 0.0036402170080691576, 0.009505377151072025, -0.014863671734929085, 0.020327288657426834, -0.023421144112944603, 0.014784679748117924, 0.018984423950314522, 0.01044669933617115, 0.020603761076927185, -0.005015995353460312, 0.02872677706182003, 0.013652459718286991, -0.010341376066207886, -0.000921573955565691, -0.006516844499856234, -0.00848506297916174, -0.015798410400748253, 0.038785096257925034, 0.005940860603004694, -0.009959581308066845, -0.013797278515994549, -0.010499360039830208, -0.01415274292230606, 0.011223454028367996, 0.037363242357969284, 0.009136747568845749, 0.010591518133878708, -0.0008754952577874064, 0.007438418455421925, -0.02489566244184971, -0.00843898393213749, -0.016232866793870926, 0.044472526758909225, 0.00947246327996254, 0.006447726394981146, 0.002983595710247755, -0.00604289211332798, -0.01785220392048359, 0.0024964779149740934, -0.0071027022786438465, 0.010084652341902256, -0.02477717399597168, 0.029648350551724434, -0.0017411165172234178, 0.012355674058198929, -0.012309595011174679, 0.021064547821879387, -0.0032008239068090916, -0.030833231285214424, -0.014508207328617573, -0.0037323744036257267, -0.008807613514363766, 0.018576297909021378, -0.006938135251402855, -0.04041760042309761, 0.008432401344180107, 0.014903167262673378, 0.031017545610666275, 0.023579128086566925, -0.018286660313606262, -3.106519443463185e-06, 0.005108152981847525, -0.014363388530910015, 0.0007430189871229231, -0.04018062353134155, 0.0208933986723423, 0.012112114578485489, -0.007148780860006809, -0.026923125609755516, -0.008392905816435814, -0.0005323735531419516, -0.008425818756222725, 0.014429215341806412, 0.00916966050863266, 0.023118341341614723, -0.002743328223004937, 0.02082757093012333, -0.029858995229005814, 0.01940571516752243, -0.02417156845331192, 0.04910672456026077, 0.03380860015749931, -0.005608435720205307, -0.005638057831674814, 0.02131468988955021, -0.008004528470337391, 0.004074673634022474, -0.0065925451926887035, -0.014402884058654308, -0.0023039348889142275, -0.010229471139609814, -0.004489381797611713, 0.0008318850887008011, -0.0014992033829912543, 0.019748013466596603, -0.014429215341806412, -0.001792132155969739, -0.0013683727011084557, -0.0071027022786438465, 0.006585962604731321, -0.018089180812239647, 0.021880798041820526, 0.006503678858280182, 0.007089536637067795, -0.0017460534581914544, -0.041734132915735245, 0.009584369137883186, -0.008748370222747326, 0.001760864513926208, 0.006691284943372011, -0.009209156967699528, 0.037942517548799515, -0.013849940150976181, -0.012454413808882236, -0.003034611465409398, 0.018286660313606262, 0.0008919519605115056, 0.016930630430579185, 0.0011815894395112991, -0.005809207446873188, -0.01801018789410591, -0.0018596046138554811, -0.007602985017001629, -0.02001132071018219, -0.01146042998880148, 0.018576297909021378, 0.0075898198410868645, -0.032597389072179794, -0.02444804087281227, 0.0031152490992099047, -0.021143538877367973, -0.006892056670039892, -0.03267638012766838, 0.02410574071109295, 0.007201442029327154, -0.01661466248333454, -0.006480639800429344, -0.026343850418925285, 0.004729649052023888, -0.02110404334962368, 0.0037949099205434322, 0.005684136413037777, -0.013678791001439095, -0.01654883474111557, 0.008419236168265343, -0.1714654117822647, 0.012763799168169498, -0.009222322143614292, -0.005417538341134787, 0.009966163896024227, 0.010229471139609814, 0.03386126086115837, -0.017786378040909767, -0.025409109890460968, -0.014613529667258263, 0.013994758948683739, 0.02143317647278309, -0.028463469818234444, -0.003439445747062564, 0.020050816237926483, 0.010920651257038116, 0.0017904865089803934, 0.012145028449594975, 0.012460996396839619, 0.013132428750395775, 0.039733003824949265, -0.0171281099319458, 0.015166474506258965, 0.001757573219947517, 0.016601497307419777, -0.01173690240830183, -0.017391417175531387, 0.017588896676898003, -0.007247521076351404, 0.009854258969426155, -0.011967295780777931, 0.004522295203059912, 0.020695917308330536, 0.006951300892978907, 0.014139577746391296, -0.004693444352596998, -0.017075449228286743, -0.012098949402570724, -0.018628958612680435, 0.016772646456956863, 0.0012507075443863869, 0.014732018113136292, 0.003024737350642681, 0.0004599641542881727, -0.005822372622787952, 0.02405308000743389, 0.013849940150976181, -0.008280999958515167, 0.009893754497170448, -0.007089536637067795, 0.011348525062203407, -0.02970101125538349, -0.013968427665531635, -0.007978197187185287, 0.013586632907390594, -0.009742353111505508, 0.028489800170063972, 0.022328419610857964, 0.00046736965305171907, 0.01727292872965336, -0.019511036574840546, -0.0049040899612009525, -0.01005173847079277, -0.009143330156803131, -0.016680488362908363, -0.00901825912296772, -0.010308463126420975, 0.025435440242290497, -0.027278589084744453, 0.006872308440506458, -0.0186421237885952, -0.006539883557707071, -0.0015568017261102796, -0.018470974639058113, 0.003024737350642681, 0.0018628959078341722, -0.012467578984797001, 0.02514580450952053, -0.013586632907390594, -0.0061811283230781555, -0.015047986060380936, 0.04831680655479431, -0.011697406880557537, -0.0009618928306736052, -0.007813630625605583, 0.0010696840472519398, -0.004459759686142206, 0.00500941276550293, 0.014323892071843147, -0.008945849724113941, -0.010091234929859638, -0.028437139466404915, -0.017536235973238945, -0.007708307821303606, -0.0011626642663031816, -0.01445554569363594, -0.0044926730915904045, 0.015008490532636642, 0.012724303640425205, -0.0028338399715721607, -0.011750067584216595, -0.010775832459330559, -0.039101067930459976, 0.0207090824842453, 0.010104400105774403, -0.0015033175004646182, 0.005394498817622662, 0.016469843685626984, 0.0188264399766922, -0.014086916111409664, -0.020998720079660416, 0.017720550298690796, 0.01615387573838234, 0.0008072000346146524, -0.0029934695921838284, 0.013211420737206936, 0.0032057608477771282, -0.014547702856361866, 0.01833932101726532, -0.0051575228571891785, 0.05782218277454376, 0.0008170740329660475, -0.019208233803510666, -0.009860841557383537, -0.007142198272049427, 0.0030263829976320267, -0.042129095643758774, -0.022762876003980637, 0.009156495332717896, 0.0140737509354949, -0.010775832459330559, 0.0114801786839962, 0.007787299808114767, 0.02830548584461212, 0.0028387769125401974, 0.02301301807165146, -0.01425806526094675, -0.015298127196729183, -0.0017707385122776031, -0.002343430882319808, 0.009893754497170448, 0.002874981611967087, -0.005644640419632196, -0.011572335846722126, -0.012375421822071075, 0.0188264399766922, -0.005177270621061325, 0.010025408118963242, -0.0077675520442426205, -0.012836208567023277, -0.01475834846496582, 0.00489750737324357, -0.017009621486067772, 0.045473091304302216, 0.026106873527169228, 0.0008421704987995327, -0.01161183137446642, -0.012678224593400955, 0.02119620144367218, -0.04047026112675667, 0.011118131689727306, -0.001620159950107336, -0.02872677706182003, -0.01764155924320221, 0.02672564424574375, -0.02875310741364956, 0.002223297255113721, 0.004792184568941593, 0.007616150658577681, -0.02389509603381157, -0.006039600819349289, 0.004650657065212727, -0.02289452962577343, -0.0011313966242596507, 0.019300391897559166, -0.0014374908059835434, -0.00994641613215208, -0.011045722290873528, -0.009011676535010338, 0.025251125916838646, 0.011697406880557537, 0.001966573065146804, -0.004561791196465492, 0.02775254100561142, -0.030174965038895607, -0.01891859620809555, 0.03291335701942444, 0.006806482095271349, -0.018879100680351257, 0.01740458235144615, -0.002631422830745578, -0.008735204115509987, -0.007859709672629833, -0.01074950210750103, 0.004489381797611713, -0.012803295627236366, 0.015350788831710815, 0.017588896676898003, -0.015219135209918022, 0.00971602275967598, -0.02951669692993164, 0.0018661872018128633, -0.039548687636852264, -0.016496174037456512, 0.01495582889765501, -0.014811010099947453, -0.01624603196978569, -0.018931761384010315, 0.0016473134746775031, -0.005539317615330219, 0.03667864203453064, 0.023908261209726334, -0.0013165342388674617, 0.01415274292230606, 0.015113812871277332, -0.008169095031917095, 0.008919519372284412, 0.019655855372548103, 0.016509339213371277, -0.02426372654736042, -0.005861868616193533, 0.02235475182533264, -0.0012079201405867934, 5.723838330595754e-05, 0.0229603573679924, 0.006832812447100878, -0.01733875647187233, -0.016009056940674782, -0.0875231921672821, 0.002610029187053442, 0.005644640419632196, -0.0016654158243909478, -0.028068508952856064, 0.004851428791880608, -0.004519003909081221, -0.012303012423217297, 0.0023960922844707966, 0.019655855372548103, 0.003613886423408985, -0.0014300852781161666, -0.003515146439895034, 0.01457403413951397, -0.01636452041566372, -0.025185300037264824, 0.009920085780322552, -0.016404015943408012, 0.012033122591674328, 0.011216871440410614, 0.012368839234113693, 0.005440577864646912, 0.012322760187089443, -0.0048250979743897915, 0.009808179922401905, -0.015034820884466171, -0.03128085285425186, 0.006931552663445473, -0.006023143883794546, 0.006204167380928993, -0.0059803565964102745, -0.0025195174384862185, -0.0020258170552551746, 0.005292467772960663, -0.014811010099947453, -0.036994609981775284, 0.0006315250066109002, 0.03975933417677879, 0.0009306251304224133, 0.05131850391626358, -0.04715825617313385, -0.019089745357632637, 0.019181903451681137, 0.0025853440165519714, -0.013915766961872578, 0.01228326465934515, -0.008353409357368946, 0.010723170824348927, -0.0005006944411434233, -0.013171925209462643, 0.02754189632833004, 0.012454413808882236, -0.0028140919748693705, -0.015442945994436741, 0.02398725412786007, -0.002973721595481038, 0.002226588549092412, 0.0016111087752506137, -0.005374751053750515, -0.018563132733106613, 0.0378371924161911, 0.016167040914297104, -1.370532663713675e-05, 0.009301314130425453, 0.0010384164052084088, -0.000883723609149456, -0.004268862307071686, 0.010736336931586266, 0.020261460915207863, -0.024921992793679237, -0.02201245166361332, -0.005108152981847525, 0.012605815194547176, 0.01457403413951397, 0.0033637448213994503, -0.009248652495443821, 0.013507640920579433, -0.014968994073569775, -0.0009347393061034381, 0.0150611512362957, 0.009841092862188816, 0.005098278634250164, -0.007563489023596048, -0.00936714094132185, 0.01288887020200491, 0.004489381797611713, 0.008794448338449001, 0.0013025460066273808, 0.016904300078749657, 0.017075449228286743, -0.023065678775310516, 0.006905221845954657, -0.0016053488943725824, -0.017628394067287445, 0.011447264812886715, 0.01314559392631054, 0.027067944407463074, 0.002438879571855068, 0.02635701559484005, 0.00916966050863266, 0.008221755735576153, -0.003607303835451603, 0.006813064683228731, -0.039548687636852264, -0.012375421822071075, 0.004930420778691769, -0.02712060511112213, -0.02182813733816147, -0.0033226031810045242, 0.030174965038895607, 0.019116077572107315, -0.0008047315641306341, -0.0008812550804577768, 0.01296786218881607, -0.026949455961585045, 0.023789772763848305, -0.008096685633063316, -0.015271796844899654, -0.023723946884274483, 0.0287004467099905, 0.0016193371266126633, -0.0008829007856547832, 0.006898639257997274, -0.024066245183348656, 0.0027449738699942827, 0.005443869158625603, 0.0067472378723323345, -0.023302655667066574, 0.020327288657426834, -0.011032557114958763, 0.009044590406119823, 0.0111576272174716, -0.006283159367740154, -0.0372842475771904, -0.01323775202035904, 0.010696840472519398, -0.007398922462016344, 0.019234564155340195, -0.000921573955565691, 0.07335728406906128, 0.015232301317155361, -0.018628958612680435, 0.015600930899381638, -0.007629315834492445, -0.0014366679824888706, 0.005749963223934174, -0.0011865264968946576, -0.011045722290873528, -0.027278589084744453, 0.008274417370557785, -0.001569144194945693, 0.019208233803510666, -0.020353619009256363, -0.00822833925485611, 0.002768013160675764, -0.0012663413072004914, 0.016298694536089897, -0.0202482957392931, -0.010380872525274754, 0.02247323840856552, -0.013849940150976181, 0.015679921954870224, 0.020972389727830887, -0.01687796786427498, -0.006533300969749689, 0.03786352276802063, -0.015719419345259666, 0.010611265897750854, -0.025040481239557266, -0.00733967823907733, 0.001685163821093738, -0.041128527373075485, -0.002995115239173174, 0.02533011883497238, -0.03865344449877739, -0.000220108064240776, -0.0048020584508776665, 0.003758705221116543, -0.001100128865800798, -0.017904864624142647, 0.03196544945240021, -0.00947246327996254, -0.027252258732914925, 0.01891859620809555, -0.01727292872965336, -0.0024750842712819576, 0.001757573219947517, -0.004022011999040842]

  relevance_out = dict()
  for count, node in enumerate(nodes): 
    node_embedding = persona.a_mem.embeddings[node.embedding_key]
    relevance_out[node.node_id] = cos_sim(node_embedding, focal_embedding)

  return relevance_out


def new_retrieve(persona, focal_points, n_count=30): 
  """
  Given the current persona and focal points (focal points are events or 
  thoughts for which we are retrieving), we retrieve a set of nodes for each
  of the focal points and return a dictionary. 

  INPUT: 
    persona: The current persona object whose memory we are retrieving. 
    focal_points: A list of focal points (string description of the events or
                  thoughts that is the focus of current retrieval).
  OUTPUT: 
    retrieved: A dictionary whose keys are a string focal point, and whose 
               values are a list of Node object in the agent's associative 
               memory.

  Example input:
    persona = <persona> object 
    focal_points = ["How are you?", "Jane is swimming in the pond"]
  """
  # <retrieved> is the main dictionary that we are returning
  retrieved = dict() 
  for focal_pt in focal_points: 
    # Getting all nodes from the agent's memory (both thoughts and events) and
    # sorting them by the datetime of creation.
    # You could also imagine getting the raw conversation, but for now. 
    nodes = [[i.last_accessed, i]
              for i in persona.a_mem.seq_event + persona.a_mem.seq_thought
              if "idle" not in i.embedding_key]
    nodes = sorted(nodes, key=lambda x: x[0])
    nodes = [i for created, i in nodes]

    # Calculating the component dictionaries and normalizing them.
    recency_out = extract_recency(persona, nodes)
    recency_out = normalize_dict_floats(recency_out, 0, 1)
    importance_out = extract_importance(persona, nodes)
    importance_out = normalize_dict_floats(importance_out, 0, 1)  
    relevance_out = extract_relevance(persona, nodes, focal_pt)
    relevance_out = normalize_dict_floats(relevance_out, 0, 1)

    # Computing the final scores that combines the component values. 
    # Note to self: test out different weights. [1, 1, 1] tends to work
    # decently, but in the future, these weights should likely be learned, 
    # perhaps through an RL-like process.
    # gw = [1, 1, 1]
    # gw = [1, 2, 1]
    gw = [0.5, 3, 2]
    master_out = dict()
    for key in recency_out.keys(): 
      master_out[key] = (persona.scratch.recency_w*recency_out[key]*gw[0] 
                     + persona.scratch.relevance_w*relevance_out[key]*gw[1] 
                     + persona.scratch.importance_w*importance_out[key]*gw[2])

    master_out = top_highest_x_values(master_out, len(master_out.keys()))
    for key, val in master_out.items(): 
      print (persona.a_mem.id_to_node[key].embedding_key, val)
      print (persona.scratch.recency_w*recency_out[key]*1, 
             persona.scratch.relevance_w*relevance_out[key]*1, 
             persona.scratch.importance_w*importance_out[key]*1)

    # Extracting the highest x values.
    # <master_out> has the key of node.id and value of float. Once we get the 
    # highest x values, we want to translate the node.id into nodes and return
    # the list of nodes.
    master_out = top_highest_x_values(master_out, n_count)
    master_nodes = [persona.a_mem.id_to_node[key] 
                    for key in list(master_out.keys())]

    for n in master_nodes: 
      n.last_accessed = persona.scratch.curr_time
      
    retrieved[focal_pt] = master_nodes

  return retrieved













